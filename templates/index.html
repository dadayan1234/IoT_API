<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Realtime Chart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1>IoT Realtime Data</h1>
    <div id="chartsContainer" class="row mt-3">
        <!-- Chart placeholders will be added dynamically -->
    </div>
</div>

<script>
    // Inisialisasi socket.io
    const socket = io();

    // Kontainer untuk menyimpan chart yang telah dibuat
    const charts = {};

    // Fungsi untuk membuat chart baru
    function createChart(chartName) {
        const chartsContainer = document.getElementById('chartsContainer');

        // Cek apakah chart sudah ada di DOM
        if (document.getElementById(`chart-${chartName}`)) {
            return; // Jangan buat chart jika sudah ada
        }

        // Buat elemen chart baru
        const chartDiv = document.createElement('div');
        chartDiv.className = 'col-md-4 mb-3';
        chartDiv.id = `chart-${chartName}`;
        chartDiv.innerHTML = `<h5>${chartName}</h5><canvas id="gaugeChart-${chartName}" width="300" height="300"></canvas>`;
        chartsContainer.appendChild(chartDiv);

        // Inisialisasi chart dengan Chart.js
        const ctx = document.getElementById(`gaugeChart-${chartName}`).getContext('2d');
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Value', 'Remaining'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#ff6384', '#e0e0e0'],
                    borderWidth: 0
                }]
            },
            options: {
                rotation: -90,
                circumference: 180,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });

        // Simpan chart ke kontainer
        charts[chartName] = chart;
    }

    // Mendengarkan data dari server melalui Socket.IO
    socket.on('update_data', (payload) => {
        const { chart_name, value } = payload;

        // Buat atau update chart
        createChart(chart_name);

        // Update nilai chart yang sudah ada
        if (charts[chart_name]) {
            charts[chart_name].data.datasets[0].data[0] = value;
            charts[chart_name].data.datasets[0].data[1] = 100 - value;
            charts[chart_name].update();
        }
    });
</script>
</body>
</html>
